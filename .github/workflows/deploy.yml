name: Deploy
on:
  push:
    branches:
      - master

jobs:
  # deploy-glenstack.com:
  #   runs-on: ubuntu-latest
  #   name: Deploy glenstack.com
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
  #     - name: Read .nvmrc
  #       run: echo ::set-output name=NVMRC::$(cat .nvmrc)
  #       id: nvm
  #     - name: Setup node
  #       uses: actions/setup-node@v2
  #       with:
  #         node-version: "${{ steps.nvm.outputs.NVMRC }}"
  #     - name: Install
  #       run: npm ci
  #     - name: Build and Upload FAB to Linc
  #       uses: gregbrimble/linc-fab-action@v1.0.0
  #       with:
  #         api_key: ${{ secrets.LINC_API_KEY }}
  #         site_name: glenstack-glenstack
  #         working_directory: packages/glenstack.com/
  deploy-api:
    runs-on: ubuntu-latest
    name: Deploy API
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Read .nvmrc
        run: echo ::set-output name=NVMRC::$(cat .nvmrc)
        id: nvm
      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: "${{ steps.nvm.outputs.NVMRC }}"
      - name: Install
        run: npm ci
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@1.3.0
        with:
          environment: production
          apiToken: ${{ secrets.CF_API_TOKEN }}
          workingDirectory: "./packages/api"
      - name: Create Sentry release
        uses: getsentry/action-release@v1.1.5
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: glenstack
          SENTRY_PROJECT: api
        with:
          environment: production
          sourcemaps: "./packages/api/dist"
